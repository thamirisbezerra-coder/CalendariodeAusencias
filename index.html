<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calend√°rio de Aus√™ncias</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js (para gr√°ficos) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilos para o "toast" de notifica√ß√£o */
        #notification-toast {
            transition: opacity 0.5s, transform 0.5s;
        }
        /* Estilos para o scrollbar */
        .modal-body::-webkit-scrollbar {
            width: 8px;
        }
        .modal-body::-webkit-scrollbar-track {
            background: #f1f5f9; /* gray-100 */
        }
        .modal-body::-webkit-scrollbar-thumb {
            background: #94a3b8; /* gray-400 */
            border-radius: 4px;
        }
        .modal-body::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* gray-500 */
        }
        /* Oculta setas em campos input[type=time] */
        input[type="time"]::-webkit-calendar-picker-indicator {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 lg:p-8 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-6xl bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="p-6 border-b border-gray-200">
            <h1 class="text-2xl font-bold text-gray-800">Calend√°rio de Aus√™ncias do Setor</h1>
            <p class="mt-1 text-sm text-gray-500">Selecione um dia para adicionar ou visualizar aus√™ncias e eventos.</p>
        </div>

        <!-- Orienta√ß√µes de Uso -->
        <div class="p-6 bg-blue-50 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-blue-800">Orienta√ß√µes de Uso</h2>
            <ul class="list-disc list-inside mt-2 text-sm text-blue-700 space-y-1">
                <li>Sempre que for se ausentar (m√©dico, banco de horas, etc.), clique no dia e adicione sua aus√™ncia.</li>
                <li>Preencha seu nome e o motivo para que todos saibam quem estar√° fora.</li>
                <li>Use a aba "Anivers√°rios" para marcar os aniversariantes do m√™s! üéÇ</li>
            </ul>
        </div>

        <!-- Calend√°rio -->
        <div class="p-6">
            <!-- Cabe√ßalho do Calend√°rio (Navega√ß√£o) -->
            <div class="flex items-center justify-between mb-4">
                <button id="prev-month" class="p-2 rounded-full text-gray-500 hover:bg-gray-200 focus:outline-none" aria-label="M√™s anterior">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <h2 id="month-year" class="text-xl font-semibold text-gray-700"></h2>
                <button id="next-month" class="p-2 rounded-full text-gray-500 hover:bg-gray-200 focus:outline-none" aria-label="Pr√≥ximo m√™s">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>

            <!-- Dias da Semana (Header) -->
            <div class="grid grid-cols-7 gap-1 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">
                <div>DOM</div>
                <div>SEG</div>
                <div>TER</div>
                <div>QUA</div>
                <div>QUI</div>
                <div>SEX</div>
                <div>S√ÅB</div>
            </div>

            <!-- Grade de Dias -->
            <div id="calendar-grid" class="grid grid-cols-7 gap-1">
                <!-- Dias ser√£o preenchidos pelo JavaScript -->
            </div>
        </div>
        
        <!-- Acesso Restrito -->
        <div class="p-4 bg-gray-50 border-t border-gray-200 text-center">
            <a href="#" id="admin-access-button" class="text-xs text-gray-400 hover:text-blue-600 transition-colors">Acesso Restrito</a>
        </div>
    </div>

    <!-- Modal de Aus√™ncia/Evento (Oculto por padr√£o) -->
    <div id="absenceModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-95 opacity-0">
            <!-- Cabe√ßalho do Modal -->
            <div class="p-5 bg-gray-50 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-800" id="modal-title">Adicionar em 20 de Nov</h3>
                    <button id="close-modal" class="p-2 rounded-full text-gray-400 hover:bg-gray-200 hover:text-gray-600 focus:outline-none" aria-label="Fechar modal">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>
            </div>

            <!-- Abas (Tabs) -->
            <div class="border-b border-gray-200 px-5 pt-4">
                <nav class="flex -mb-px space-x-4 overflow-x-auto">
                    <button id="tab-absences" class="tab-button whitespace-nowrap pb-3 px-1 border-b-2 font-medium text-sm text-blue-600 border-blue-600" aria-current="page">
                        Aus√™ncias
                    </button>
                    <button id="tab-events" class="tab-button whitespace-nowrap pb-3 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300">
                        Eventos
                    </button>
                    <!-- (NOVA) Aba Anivers√°rios -->
                    <button id="tab-birthdays" class="tab-button whitespace-nowrap pb-3 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300">
                        Anivers√°rios
                    </button>
                </nav>
            </div>

            <!-- Corpo do Modal (com scroll) -->
            <div class="p-5 modal-body" style="max-height: 60vh; overflow-y: auto;">
                
                <!-- Conte√∫do da Aba: Aus√™ncias -->
                <div id="content-absences" class="tab-content space-y-6">
                    <!-- Formul√°rio de Nova Aus√™ncia -->
                    <div class="space-y-4">
                        <h4 class="text-md font-semibold text-gray-700">Adicionar Nova Aus√™ncia</h4>
                        <div>
                            <label for="colaborador" class="block text-sm font-medium text-gray-700 mb-1">Nome do Colaborador</label>
                            <input type="text" id="colaborador" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Seu nome">
                        </div>
                        <div>
                            <label for="tipo-ausencia" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Aus√™ncia</label>
                            <select id="tipo-ausencia" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <option value="medical">Atestado M√©dico</option>
                                <option value="time_bank">Banco de Horas</option>
                                <option value="personal">Motivo Pessoal</option>
                            </select>
                        </div>
                        
                        <div class="relative flex items-start">
                            <div class="flex items-center h-5">
                                <input id="dia-todo" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="dia-todo" class="font-medium text-gray-700">Dia todo</label>
                            </div>
                        </div>

                        <div id="time-fields" class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="hora-inicio" class="block text-sm font-medium text-gray-700 mb-1">Hora In√≠cio</label>
                                <input type="time" id="hora-inicio" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="hora-fim" class="block text-sm font-medium text-gray-700 mb-1">Hora Fim</label>
                                <input type="time" id="hora-fim" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </div>
                        </div>

                        <div>
                            <label for="observacao" class="block text-sm font-medium text-gray-700 mb-1">Observa√ß√£o (Opcional)</label>
                            <textarea id="observacao" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ex: Atestado de comparecimento, consulta..."></textarea>
                        </div>
                        
                        <button id="save-absence" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md font-semibold shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                            Salvar Aus√™ncia
                        </button>
                    </div>

                    <!-- Divisor -->
                    <div class="border-t border-gray-200"></div>

                    <!-- Lista de Aus√™ncias do Dia -->
                    <div>
                        <h4 class="text-md font-semibold text-gray-700 mb-3">Aus√™ncias Registradas</h4>
                        <div id="absences-list" class="space-y-3">
                            <!-- Lista preenchida pelo JS -->
                            <p class="text-sm text-gray-500">Nenhuma aus√™ncia registrada para este dia.</p>
                        </div>
                    </div>
                </div>

                <!-- Conte√∫do da Aba: Eventos -->
                <div id="content-events" class="tab-content space-y-6 hidden">
                    <!-- Formul√°rio de Novo Evento -->
                    <div class="space-y-4">
                        <h4 class="text-md font-semibold text-gray-700">Adicionar Novo Evento/Feriado</h4>
                        <div>
                            <label for="event-name" class="block text-sm font-medium text-gray-700 mb-1">Nome do Evento</label>
                            <input type="text" id="event-name" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ex: Feriado Municipal, Reuni√£o Geral">
                        </div>
                        <button id="save-event" class="w-full bg-purple-600 text-white py-2 px-4 rounded-md font-semibold shadow-sm hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-colors">
                            Salvar Evento
                        </button>
                    </div>

                    <!-- Divisor -->
                    <div class="border-t border-gray-200"></div>

                    <!-- Lista de Eventos do Dia -->
                    <div>
                        <h4 class="text-md font-semibold text-gray-700 mb-3">Eventos Registrados</h4>
                        <div id="events-list" class="space-y-3">
                            <!-- Lista preenchida pelo JS -->
                            <p class="text-sm text-gray-500">Nenhum evento registrado para este dia.</p>
                        </div>
                    </div>
                </div>

                <!-- (NOVO) Conte√∫do da Aba: Anivers√°rios -->
                <div id="content-birthdays" class="tab-content space-y-6 hidden">
                    <!-- Formul√°rio de Novo Anivers√°rio -->
                    <div class="space-y-4">
                        <h4 class="text-md font-semibold text-gray-700">Adicionar Aniversariante</h4>
                        <div>
                            <label for="birthday-person" class="block text-sm font-medium text-gray-700 mb-1">Nome do Aniversariante</label>
                            <input type="text" id="birthday-person" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500 sm:text-sm" placeholder="Nome do colega">
                        </div>
                        <button id="save-birthday" class="w-full bg-pink-500 text-white py-2 px-4 rounded-md font-semibold shadow-sm hover:bg-pink-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500 transition-colors">
                            Salvar Anivers√°rio üéÇ
                        </button>
                    </div>
                    
                    <div class="bg-pink-50 border border-pink-100 rounded-md p-3">
                         <p class="text-xs text-pink-800 flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            O aniversariante aparecer√° na lista de Eventos.
                         </p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modal de Senha (Admin) -->
    <div id="passwordModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm p-6 space-y-4">
            <h3 class="text-lg font-semibold text-gray-800">Acesso Restrito</h3>
            <div>
                <label for="admin-password" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                <input type="password" id="admin-password" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                <p id="password-error" class="text-xs text-red-600 mt-1 hidden">Senha incorreta.</p>
            </div>
            <div class="flex items-center justify-end space-x-3">
                <button id="cancel-password" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none">
                    Cancelar
                </button>
                <button id="submit-password" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md shadow-sm hover:bg-blue-700 focus:outline-none">
                    Entrar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Relat√≥rio (Admin) -->
    <div id="reportModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-3xl transform transition-all scale-95 opacity-0">
            <!-- Cabe√ßalho -->
            <div class="p-5 bg-gray-50 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-800">Relat√≥rio de Aus√™ncias</h3>
                    <button id="close-report" class="p-2 rounded-full text-gray-400 hover:bg-gray-200 hover:text-gray-600 focus:outline-none" aria-label="Fechar relat√≥rio">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>
                <!-- Filtro de Relat√≥rio -->
                <div class="mt-4 flex items-center justify-between space-x-2">
                    <span class="text-sm font-medium text-gray-700">Filtro do Relat√≥rio:</span>
                    <div class="flex items-center space-x-1">
                         <button id="report-prev-year" class="p-2 rounded-full text-gray-500 hover:bg-gray-200 focus:outline-none" aria-label="Ano anterior">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <span id="report-year" class="text-sm font-semibold text-gray-700 w-12 text-center">2024</span>
                         <button id="report-next-year" class="p-2 rounded-full text-gray-500 hover:bg-gray-200 focus:outline-none" aria-label="Pr√≥ximo ano">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                    <select id="report-month-select" class="w-40 border border-gray-300 rounded-md shadow-sm py-1.5 px-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="-1">Ano Inteiro</option>
                        <option value="0">Janeiro</option>
                        <option value="1">Fevereiro</option>
                        <option value="2">Mar√ßo</option>
                        <option value="3">Abril</option>
                        <option value="4">Maio</option>
                        <option value="5">Junho</option>
                        <option value="6">Julho</option>
                        <option value="7">Agosto</option>
                        <option value="8">Setembro</option>
                        <option value="9">Outubro</option>
                        <option value="10">Novembro</option>
                        <option value="11">Dezembro</option>
                    </select>
                </div>
            </div>

            <!-- Corpo -->
            <div class="p-6 modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Gr√°fico -->
                    <div>
                        <h4 class="text-md font-semibold text-gray-700 mb-2" id="pie-chart-title">Aus√™ncias por Tipo</h4>
                        <div class="w-full h-64 flex items-center justify-center bg-gray-50 rounded-lg p-4">
                            <canvas id="monthPieChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Lista -->
                    <div>
                        <h4 class="text-md font-semibold text-gray-700 mb-2" id="medical-report-title">Atestados M√©dicos</h4>
                        <div id="medical-report-list" class="space-y-2 text-sm p-4 bg-gray-50 rounded-lg h-64 overflow-y-auto">
                            <!-- Lista preenchida pelo JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Notifica√ß√£o "Toast" (Oculta) -->
    <div id="notification-toast" class="fixed bottom-5 right-5 w-full max-w-sm bg-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden z-50 transform translate-x-full opacity-0">
        <div class="p-4">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg class="h-6 w-6 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div class="ml-3 w-0 flex-1 pt-0.5">
                    <p class="text-sm font-medium text-gray-900" id="notification-title">Nova Atividade!</p>
                    <p class="mt-1 text-sm text-gray-500" id="notification-message">Um novo item foi adicionado ao calend√°rio.</p>
                </div>
                <div class="ml-4 flex-shrink-0 flex">
                    <button id="notification-close" class="bg-white rounded-md inline-flex text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <span class="sr-only">Fechar</span>
                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Banner de Erro Fatal (Oculto) -->
    <div id="fatalErrorOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 z-[9998] hidden">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6 text-center">
            <svg class="w-16 h-16 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Erro Cr√≠tico</h2>
            <p class="text-gray-600" id="fatalErrorMessage">Ocorreu um erro inesperado e a aplica√ß√£o n√£o pode continuar.</p>
        </div>
    </div>


    <!-- Vari√°veis Globais -->
    <script>
        var db;
        var auth;
        var userId;
        var currentDate = new Date();
        var selectedDateISO; 
        var allAbsences = []; 
        var allEvents = []; 
        var absencesCollectionRef; 
        var eventsCollectionRef; 
        var notificationTimer;
        var isInitialAbsenceLoad = true; 
        var isInitialEventLoad = true;
        var hasNotificationPermission = false; 
        var myPieChart = null;
        const ADMIN_PASSWORD = "paula2025"; 
        var reportFilterDate = new Date(); 
    </script>
    
    <div id="app-script">
        <script type="module">
        // Importa√ß√µes do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            where, 
            onSnapshot, 
            addDoc, 
            deleteDoc, 
            doc,
            setDoc,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configura√ß√£o do Firebase ---
        const firebaseConfig = {
          apiKey: "AIzaSyCe8E7k7vsCRZM9wybNqj7M7UXLpuYcis8",
          authDomain: "calendariodeausencias.firebaseapp.com",
          projectId: "calendariodeausencias",
          storageBucket: "calendariodeausencias.firebasestorage.app",
          messagingSenderId: "574582108917",
          appId: "1:574582108917:web:6491a2ea49e6aa13038bbc",
          measurementId: "G-DGWE7SVBYX"
        };
        
        // --- Elementos do DOM ---
        const calendarGrid = document.getElementById('calendar-grid');
        const monthYear = document.getElementById('month-year');
        const prevMonthButton = document.getElementById('prev-month');
        const nextMonthButton = document.getElementById('next-month');
        
        const modal = document.getElementById('absenceModal');
        const modalTitle = document.getElementById('modal-title');
        const closeModal = document.getElementById('close-modal');
        const colaboradorInput = document.getElementById('colaborador');
        const tipoAusenciaInput = document.getElementById('tipo-ausencia');
        
        const diaTodoCheckbox = document.getElementById('dia-todo');
        const timeFieldsContainer = document.getElementById('time-fields');
        const horaInicioInput = document.getElementById('hora-inicio');
        const horaFimInput = document.getElementById('hora-fim');
        const observacaoInput = document.getElementById('observacao'); 
        
        const saveAbsenceButton = document.getElementById('save-absence');
        const absencesList = document.getElementById('absences-list');

        const eventNameInput = document.getElementById('event-name');
        const saveEventButton = document.getElementById('save-event');
        const eventsList = document.getElementById('events-list');

        // (NOVO) Elementos de Anivers√°rio
        const birthdayPersonInput = document.getElementById('birthday-person');
        const saveBirthdayButton = document.getElementById('save-birthday');

        // Abas
        const tabAbsences = document.getElementById('tab-absences');
        const tabEvents = document.getElementById('tab-events');
        const tabBirthdays = document.getElementById('tab-birthdays'); // (NOVO)
        
        const contentAbsences = document.getElementById('content-absences');
        const contentEvents = document.getElementById('content-events');
        const contentBirthdays = document.getElementById('content-birthdays'); // (NOVO)
        
        const notificationToast = document.getElementById('notification-toast');
        const notificationTitle = document.getElementById('notification-title');
        const notificationMessage = document.getElementById('notification-message');
        const notificationClose = document.getElementById('notification-close');

        const fatalErrorOverlay = document.getElementById('fatalErrorOverlay');
        const fatalErrorMessage = document.getElementById('fatalErrorMessage');

        const adminAccessButton = document.getElementById('admin-access-button');
        const passwordModal = document.getElementById('passwordModal');
        const adminPasswordInput = document.getElementById('admin-password');
        const cancelPasswordButton = document.getElementById('cancel-password');
        const submitPasswordButton = document.getElementById('submit-password');
        const passwordError = document.getElementById('password-error');

        const reportModal = document.getElementById('reportModal');
        const closeReportButton = document.getElementById('close-report');
        const monthPieChartCanvas = document.getElementById('monthPieChart');
        const medicalReportList = document.getElementById('medical-report-list');
        const pieChartTitle = document.getElementById('pie-chart-title');
        const medicalReportTitle = document.getElementById('medical-report-title');
        
        const reportPrevYearButton = document.getElementById('report-prev-year');
        const reportNextYearButton = document.getElementById('report-next-year');
        const reportYearSpan = document.getElementById('report-year');
        const reportMonthSelect = document.getElementById('report-month-select');

        
        /**
         * Inicializa o Firebase
         */
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                const analytics = getAnalytics(app);
                
                db = getFirestore(app);
                auth = getAuth(app);
                
                setupAuthObserver();
                await authenticateUser();

            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                showFatalError("Falha ao carregar componentes principais. Verifique sua conex√£o e as configura√ß√µes do Firebase.");
            }
        }
        
        /**
         * Exibe um erro fatal que bloqueia a tela.
         */
        function showFatalError(message) {
            fatalErrorMessage.textContent = message;
            fatalErrorOverlay.classList.remove('hidden');
        }

        /**
         * Autentica o usu√°rio anonimamente.
         */
        async function authenticateUser() {
            try {
                await signInAnonymously(auth);
                console.log("Usu√°rio autenticado anonimamente.");
            } catch (error) {
                console.error("Erro na autentica√ß√£o:", error);
                if (error.code === 'auth/configuration-not-found') {
                    showFatalError("Erro de Autentica√ß√£o. O 'Login An√¥nimo' n√£o est√° ativado no seu painel do Firebase. V√° em 'Authentication' -> 'Sign-in method' e ative 'An√¥nimo'.");
                } else {
                    showFatalError(`Erro de Autentica√ß√£o: ${error.message}`);
                }
            }
        }

        /**
         * Configura o listener do estado de autentica√ß√£o.
         */
        function setupAuthObserver() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    
                    if (!db) {
                        console.error("Observador: 'db' (Firestore) ainda n√£o est√° pronto!");
                        showFatalError("A conex√£o com o banco de dados falhou. Tentando reconectar...");
                        return;
                    }

                    const absenceCollectionPath = `absences`;
                    const eventCollectionPath = `events`;

                    const absRef = collection(db, absenceCollectionPath);
                    const evtRef = collection(db, eventCollectionPath);
                    
                    absencesCollectionRef = absRef;
                    eventsCollectionRef = evtRef;
                    
                    listenToAbsences(absRef);
                    listenToEvents(evtRef);

                    requestNotificationPermission();

                } else {
                    userId = null;
                }
            });
        }
        
        /**
         * Pede permiss√£o para Notifica√ß√µes do Navegador
         */
        function requestNotificationPermission() {
            if (!("Notification" in window)) return;

            if (Notification.permission !== "granted" && Notification.permission !== "denied") {
                Notification.requestPermission();
            }
        }

        /**
         * Mostra uma notifica√ß√£o (Toast ou Push)
         */
        function notifyNewEntry(title, message, docData) {
            if (docData.createdBy === userId) return;
            
            if (Notification.permission === "granted" && document.hidden) {
                new Notification(title, {
                    body: message,
                    icon: "https://placehold.co/48x48/blue/white?text=!"
                });
            } else {
                showToastNotification(title, message);
            }
        }


        /**
         * Escuta mudan√ßas na cole√ß√£o 'absences'.
         */
        function listenToAbsences(refToListen) {
            if (!refToListen) return;

            const q = query(refToListen); 
            
            onSnapshot(q, (snapshot) => {
                allAbsences = [];
                snapshot.forEach((doc) => {
                    allAbsences.push({ id: doc.id, ...doc.data() });
                });
                
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added" && !isInitialAbsenceLoad) {
                        const newAbsence = change.doc.data();
                        notifyNewEntry(
                            "Nova Aus√™ncia Registrada",
                            `${newAbsence.colaborador} marcou: ${getAbsenceTypeText(newAbsence.tipo)}`,
                            newAbsence
                        );
                    }
                });
                
                isInitialAbsenceLoad = false;
                renderCalendar(); 
                updateModalListsIfOpen(); 
                updateReportDataIfOpen(); 

            }, (error) => {
                console.error("Erro ao escutar aus√™ncias:", error);
            });
        }

        /**
         * Escuta mudan√ßas na cole√ß√£o 'events'.
         */
        function listenToEvents(refToListen) {
            if (!refToListen) return;
            
            const q = query(refToListen); 
            
            onSnapshot(q, (snapshot) => {
                allEvents = [];
                snapshot.forEach((doc) => {
                    allEvents.push({ id: doc.id, ...doc.data() });
                });

                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added" && !isInitialEventLoad) {
                        const newEvent = change.doc.data();
                        // (NOVO) Verifica se √© anivers√°rio para a mensagem
                        const msg = newEvent.type === 'birthday' 
                            ? `Anivers√°rio de ${newEvent.nome}!` 
                            : `Novo Evento: ${newEvent.nome}`;
                            
                        notifyNewEntry("Novidade no Calend√°rio", msg, newEvent);
                    }
                });

                isInitialEventLoad = false;
                renderCalendar();
                updateModalListsIfOpen();

            }, (error) => {
                console.error("Erro ao escutar eventos:", error);
            });
        }


        /**
         * Renderiza o calend√°rio para o m√™s atual.
         */
        function renderCalendar() {
            calendarGrid.innerHTML = '';
            
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            
            monthYear.textContent = currentDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            for (let i = 0; i < firstDayOfMonth; i++) {
                calendarGrid.appendChild(document.createElement('div'));
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateISO = date.toISOString().split('T')[0];
                
                const daySquare = document.createElement('div');
                daySquare.className = 'relative p-2 h-24 lg:h-32 border border-gray-200 bg-white rounded-lg cursor-pointer hover:bg-gray-50 transition-colors flex flex-col overflow-hidden';
                daySquare.dataset.date = dateISO;
                
                const dayNumber = document.createElement('span');
                dayNumber.className = 'font-semibold text-sm text-gray-700';
                dayNumber.textContent = day;
                
                if (isToday(date)) {
                    dayNumber.className = 'flex items-center justify-center w-6 h-6 bg-blue-600 text-white rounded-full font-bold text-sm';
                    daySquare.classList.add('bg-blue-50');
                }
                daySquare.appendChild(dayNumber);
                
                const pillsContainer = document.createElement('div');
                pillsContainer.className = 'mt-1.5 space-y-1 overflow-y-auto overflow-x-hidden flex-1';

                const absencesForDay = allAbsences.filter(a => a.date === dateISO);
                absencesForDay.forEach(absence => {
                    const pill = createAbsencePill(absence);
                    pillsContainer.appendChild(pill);
                });

                const eventsForDay = allEvents.filter(e => e.date === dateISO);
                eventsForDay.forEach(event => {
                    const pill = createEventPill(event);
                    pillsContainer.appendChild(pill);
                });
                
                daySquare.appendChild(pillsContainer);
                calendarGrid.appendChild(daySquare);
            }
        }
        
        /**
         * Cria uma "p√≠lula" de aus√™ncia para o calend√°rio.
         */
        function createAbsencePill(absence) {
            const pill = document.createElement('div');
            let bgColor, textColor, borderColor;
            
            switch (absence.tipo) {
                case 'medical':
                    bgColor = 'bg-red-100'; textColor = 'text-red-800'; borderColor = 'border-red-300';
                    break;
                case 'time_bank':
                    bgColor = 'bg-blue-100'; textColor = 'text-blue-800'; borderColor = 'border-blue-300';
                    break;
                case 'personal':
                    bgColor = 'bg-orange-100'; textColor = 'text-orange-800'; borderColor = 'border-orange-300';
                    break;
                default:
                    bgColor = 'bg-gray-100'; textColor = 'text-gray-800'; borderColor = 'border-gray-300';
            }
            
            pill.className = `w-full text-xs font-medium px-2 py-0.5 rounded-md truncate ${bgColor} ${textColor} border ${borderColor}`;
            pill.textContent = absence.colaborador; 
            return pill;
        }

        /**
         * Cria uma "p√≠lula" de evento para o calend√°rio.
         */
        function createEventPill(event) {
            const pill = document.createElement('div');
            
            // (NOVO) Estilo diferente para Anivers√°rio
            if (event.type === 'birthday') {
                pill.className = `w-full text-xs font-medium px-2 py-0.5 rounded-md truncate bg-pink-100 text-pink-800 border border-pink-300`;
                pill.textContent = `üéÇ ${event.nome}`;
            } else {
                pill.className = `w-full text-xs font-medium px-2 py-0.5 rounded-md truncate bg-purple-100 text-purple-800 border border-purple-300`;
                pill.textContent = event.nome;
            }
            return pill;
        }

        /**
         * Verifica se uma data √© "hoje".
         */
        function isToday(date) {
            const today = new Date();
            return date.getDate() === today.getDate() &&
                   date.getMonth() === today.getMonth() &&
                   date.getFullYear() === today.getFullYear();
        }

        /**
         * Abre o modal para uma data espec√≠fica.
         */
        function openModal(dateISO) {
            selectedDateISO = dateISO;
            const dateObj = new Date(dateISO + 'T12:00:00'); 
            
            const formattedDate = dateObj.toLocaleDateString('pt-BR', { day: 'numeric', month: 'long' });
            modalTitle.textContent = `Atividades para ${formattedDate}`;
            
            updateModalLists();
            
            colaboradorInput.value = '';
            tipoAusenciaInput.value = 'medical';
            eventNameInput.value = '';
            birthdayPersonInput.value = ''; // (NOVO)
            
            diaTodoCheckbox.checked = true; 
            toggleTimeFields(); 
            horaInicioInput.value = '';
            horaFimInput.value = '';
            observacaoInput.value = ''; 
            
            showTab('absences');
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.firstElementChild.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        /**
         * Fecha o modal de aus√™ncia.
         */
        function closeModalHandler() {
            modal.firstElementChild.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 150);
        }
        
        /**
         * Mostra/esconde campos de hora baseado no "Dia todo"
         */
        function toggleTimeFields() {
            if (diaTodoCheckbox.checked) {
                timeFieldsContainer.classList.add('hidden');
            } else {
                timeFieldsContainer.classList.remove('hidden');
            }
        }
        
        
        /**
         * Atualiza as listas (Aus√™ncias e Eventos) dentro do modal.
         */
        function updateModalLists() {
            // Atualiza lista de aus√™ncias
            const absencesForDay = allAbsences.filter(a => a.date === selectedDateISO);
            absencesList.innerHTML = '';
            if (absencesForDay.length === 0) {
                absencesList.innerHTML = '<p class="text-sm text-gray-500">Nenhuma aus√™ncia registrada para este dia.</p>';
            } else {
                absencesForDay.forEach(absence => {
                    const item = document.createElement('div');
                    item.className = 'flex items-start justify-between p-3 bg-gray-50 rounded-lg border border-gray-200';
                    
                    const observacao = absence.observacao ? 
                        `<p class="text-xs text-gray-500 italic mt-1">${escapeHTML(absence.observacao)}</p>` : '';
                    
                    const detalhes = absence.detalhes ? 
                        `<p class="text-sm text-gray-600">${escapeHTML(absence.detalhes)}</p>` : '';
                    
                    item.innerHTML = `
                        <div class="flex-1">
                            <p class="font-semibold text-sm text-gray-800">${escapeHTML(absence.colaborador)}</p>
                            <p class="text-sm text-gray-600">${getAbsenceTypeText(absence.tipo)}</p>
                            ${detalhes}
                            ${observacao}
                        </div>
                        <button data-id="${absence.id}" class="delete-absence flex-shrink-0 ml-2 p-1.5 rounded-full text-gray-400 hover:bg-red-100 hover:text-red-600 focus:outline-none" aria-label="Excluir aus√™ncia">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                        </button>
                    `;
                    absencesList.appendChild(item);
                });
            }

            // Atualiza lista de eventos
            const eventsForDay = allEvents.filter(e => e.date === selectedDateISO);
            eventsList.innerHTML = '';
            if (eventsForDay.length === 0) {
                eventsList.innerHTML = '<p class="text-sm text-gray-500">Nenhum evento registrado para este dia.</p>';
            } else {
                eventsForDay.forEach(event => {
                    const item = document.createElement('div');
                    // (NOVO) Estilo condicional para anivers√°rio
                    if (event.type === 'birthday') {
                        item.className = 'flex items-center justify-between p-3 bg-pink-50 rounded-lg border border-pink-200';
                        item.innerHTML = `
                            <p class="font-semibold text-sm text-pink-800">üéÇ ${escapeHTML(event.nome)}</p>
                            <button data-id="${event.id}" class="delete-event p-1.5 rounded-full text-gray-400 hover:bg-pink-100 hover:text-pink-600 focus:outline-none" aria-label="Excluir evento">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                            </button>
                        `;
                    } else {
                        item.className = 'flex items-center justify-between p-3 bg-purple-50 rounded-lg border border-purple-200';
                        item.innerHTML = `
                            <p class="font-semibold text-sm text-purple-800">${escapeHTML(event.nome)}</p>
                            <button data-id="${event.id}" class="delete-event p-1.5 rounded-full text-gray-400 hover:bg-red-100 hover:text-red-600 focus:outline-none" aria-label="Excluir evento">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                            </button>
                        `;
                    }
                    eventsList.appendChild(item);
                });
            }
        }
        
        /**
         * Sanitiza HTML para evitar XSS
         */
        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, function(m) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[m];
            });
        }
        
        /**
         * Atualiza o modal (se ele estiver aberto)
         */
        function updateModalListsIfOpen() {
            if (!modal.classList.contains('hidden')) {
                updateModalLists();
            }
        }

        /**
         * Atualiza o relat√≥rio (se estiver aberto)
         */
        function updateReportDataIfOpen() {
            if (!reportModal.classList.contains('hidden')) {
                updateReportData();
            }
        }
        
        /**
         * Retorna o texto leg√≠vel para o tipo de aus√™ncia.
         */
        function getAbsenceTypeText(type) {
            switch(type) {
                case 'medical': return 'Atestado M√©dico';
                case 'time_bank': return 'Banco de Horas';
                case 'personal': return 'Motivo Pessoal';
                default: return 'Outro';
            }
        }
        
        /**
         * Salva uma nova aus√™ncia no Firestore.
         */
        async function handleSaveAbsence() {
            const colaborador = colaboradorInput.value.trim();
            const tipo = tipoAusenciaInput.value;
            const observacao = observacaoInput.value.trim(); 
            
            if (!colaborador) {
                alert('Por favor, insira o nome do colaborador.');
                return;
            }
            
            let detalhes = "Dia todo";
            if (!diaTodoCheckbox.checked) {
                const inicio = horaInicioInput.value;
                const fim = horaFimInput.value;
                
                if (!inicio || !fim) {
                    alert('Por favor, preencha a Hora In√≠cio e a Hora Fim.');
                    return;
                }
                if (fim <= inicio) {
                    alert('A Hora Fim deve ser maior que a Hora In√≠cio.');
                    return;
                }
                detalhes = `Das ${inicio} √†s ${fim}`;
            }

            if (!selectedDateISO) return;
            
            try {
                await addDoc(absencesCollectionRef, {
                    date: selectedDateISO,
                    colaborador: colaborador,
                    tipo: tipo,
                    detalhes: detalhes, 
                    isAllDay: diaTodoCheckbox.checked, 
                    startTime: diaTodoCheckbox.checked ? null : horaInicioInput.value,
                    endTime: diaTodoCheckbox.checked ? null : horaFimInput.value,
                    observacao: observacao, 
                    createdAt: Timestamp.now(),
                    createdBy: userId 
                });
                
                closeModalHandler();
                
            } catch (error) {
                console.error("Erro ao salvar aus√™ncia:", error);
                alert("Erro ao salvar. Tente novamente.");
            }
        }

        /**
         * Salva um novo evento no Firestore.
         */
        async function handleSaveEvent() {
            const nome = eventNameInput.value.trim();
            
            if (!nome) {
                alert('Por favor, insira o nome do evento.');
                return;
            }
            
            if (!selectedDateISO) return;
            
            try {
                await addDoc(eventsCollectionRef, {
                    date: selectedDateISO,
                    nome: nome,
                    type: 'general', // (NOVO) Define tipo geral
                    createdAt: Timestamp.now(),
                    createdBy: userId 
                });
                
                eventNameInput.value = '';
                closeModalHandler();
                
            } catch (error) {
                console.error("Erro ao salvar evento:", error);
                alert("Erro ao salvar. Tente novamente.");
            }
        }

        /**
         * (NOVO) Salva um novo anivers√°rio no Firestore (como evento).
         */
        async function handleSaveBirthday() {
            const nome = birthdayPersonInput.value.trim();
            
            if (!nome) {
                alert('Por favor, insira o nome do aniversariante.');
                return;
            }
            
            if (!selectedDateISO) return;
            
            try {
                await addDoc(eventsCollectionRef, {
                    date: selectedDateISO,
                    nome: nome,
                    type: 'birthday', // (NOVO) Define tipo anivers√°rio
                    createdAt: Timestamp.now(),
                    createdBy: userId 
                });
                
                birthdayPersonInput.value = '';
                closeModalHandler();
                
            } catch (error) {
                console.error("Erro ao salvar anivers√°rio:", error);
                alert("Erro ao salvar. Tente novamente.");
            }
        }

        /**
         * Deleta uma aus√™ncia do Firestore.
         */
        async function handleDeleteAbsence(e) {
            if (!e.target.closest('.delete-absence')) return;
            const id = e.target.closest('.delete-absence').dataset.id;
            if (!id) return;
            
            if (confirm('Tem certeza que deseja excluir esta aus√™ncia?')) {
                try {
                    await deleteDoc(doc(absencesCollectionRef, id));
                } catch (error) {
                    console.error("Erro ao deletar aus√™ncia:", error);
                    alert("Erro ao deletar. Tente novamente.");
                }
            }
        }

        /**
         * Deleta um evento do Firestore.
         */
        async function handleDeleteEvent(e) {
            if (!e.target.closest('.delete-event')) return;
            const id = e.target.closest('.delete-event').dataset.id;
            if (!id) return;
            
            if (confirm('Tem certeza que deseja excluir este item?')) {
                try {
                    await deleteDoc(doc(eventsCollectionRef, id));
                } catch (error) {
                    console.error("Erro ao deletar evento:", error);
                    alert("Erro ao deletar. Tente novamente.");
                }
            }
        }
        
        /**
         * Mostra a notifica√ß√£o "toast"
         */
        function showToastNotification(title, message) {
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            
            if (notificationTimer) {
                clearTimeout(notificationTimer);
            }

            notificationToast.classList.remove('opacity-0', 'translate-x-full');
            notificationToast.classList.add('opacity-100', 'translate-x-0');

            notificationTimer = setTimeout(() => {
                hideNotification();
            }, 5000); 
        }
        
        /**
         * Esconde a notifica√ß√£o "toast"
         */
        function hideNotification() {
            notificationToast.classList.add('opacity-0');
            setTimeout(() => {
                notificationToast.classList.add('translate-x-full');
            }, 500); 
        }


        /**
         * Controla a troca de abas no modal
         */
        function showTab(tabId) {
            // Resetar estilos de todos
            [tabAbsences, tabEvents, tabBirthdays].forEach(btn => {
                btn.classList.remove('text-blue-600', 'border-blue-600');
                btn.classList.add('text-gray-500', 'border-transparent', 'hover:text-gray-700', 'hover:border-gray-300');
            });
            [contentAbsences, contentEvents, contentBirthdays].forEach(div => div.classList.add('hidden'));

            // Ativar o selecionado
            if (tabId === 'absences') {
                tabAbsences.classList.add('text-blue-600', 'border-blue-600');
                tabAbsences.classList.remove('text-gray-500', 'border-transparent', 'hover:text-gray-700', 'hover:border-gray-300');
                contentAbsences.classList.remove('hidden');
            } else if (tabId === 'events') {
                tabEvents.classList.add('text-blue-600', 'border-blue-600');
                tabEvents.classList.remove('text-gray-500', 'border-transparent', 'hover:text-gray-700', 'hover:border-gray-300');
                contentEvents.classList.remove('hidden');
            } else if (tabId === 'birthdays') {
                tabBirthdays.classList.add('text-blue-600', 'border-blue-600');
                tabBirthdays.classList.remove('text-gray-500', 'border-transparent', 'hover:text-gray-700', 'hover:border-gray-300');
                contentBirthdays.classList.remove('hidden');
            }
        }
        
        
        // --- Fun√ß√µes do Relat√≥rio (Admin) ---
        
        function showPasswordModal() {
            adminPasswordInput.value = '';
            passwordError.classList.add('hidden');
            passwordModal.classList.remove('hidden');
        }

        function hidePasswordModal() {
            passwordModal.classList.add('hidden');
        }

        function checkPassword() {
            if (adminPasswordInput.value === ADMIN_PASSWORD) {
                hidePasswordModal();
                showReportModal();
            } else {
                passwordError.classList.remove('hidden');
            }
        }
        
        function showReportModal() {
            reportFilterDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            reportYearSpan.textContent = reportFilterDate.getFullYear();
            reportMonthSelect.value = reportFilterDate.getMonth();
            
            updateReportData(); 
            
            reportModal.classList.remove('hidden');
            setTimeout(() => {
                reportModal.firstElementChild.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }
        
        function updateReportData() {
            const year = reportFilterDate.getFullYear();
            const month = parseInt(reportMonthSelect.value, 10); 
            
            reportYearSpan.textContent = year;
            
            let periodAbsences = [];
            let chartTitleText = "";
            let listTitleText = "";
            
            if (month === -1) { 
                periodAbsences = allAbsences.filter(a => {
                    const absenceDate = new Date(a.date + 'T12:00:00');
                    return absenceDate.getFullYear() === year;
                });
                chartTitleText = `Aus√™ncias por Tipo (${year})`;
                listTitleText = `Atestados M√©dicos (${year})`;
            } else { 
                reportFilterDate.setMonth(month); 
                const monthName = reportFilterDate.toLocaleDateString('pt-BR', { month: 'long' });
                
                periodAbsences = allAbsences.filter(a => {
                    const absenceDate = new Date(a.date + 'T12:00:00');
                    return absenceDate.getFullYear() === year && absenceDate.getMonth() === month;
                });
                chartTitleText = `Aus√™ncias por Tipo (${monthName}/${year})`;
                listTitleText = `Atestados M√©dicos (${monthName}/${year})`;
            }
            
            const typeCounts = { medical: 0, time_bank: 0, personal: 0 };
            periodAbsences.forEach(a => {
                if (a.tipo in typeCounts) {
                    typeCounts[a.tipo]++;
                }
            });
            pieChartTitle.textContent = chartTitleText;
            renderPieChart(typeCounts); 
            
            const medicalAbsences = periodAbsences.filter(a => a.tipo === 'medical');
            const medicalCounts = medicalAbsences.reduce((acc, a) => {
                acc[a.colaborador] = (acc[a.colaborador] || 0) + 1;
                return acc;
            }, {});
            
            medicalReportTitle.textContent = listTitleText;
            medicalReportList.innerHTML = '';
            
            if (Object.keys(medicalCounts).length === 0) {
                medicalReportList.innerHTML = '<p class="text-gray-500">Nenhum atestado m√©dico registrado neste per√≠odo.</p>';
            } else {
                const sortedCounts = Object.entries(medicalCounts).sort((a, b) => a[0].localeCompare(b[0]));
                
                for (const [colaborador, count] of sortedCounts) {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-2 rounded hover:bg-gray-100';
                    item.innerHTML = `
                        <span class="font-medium text-gray-700">${escapeHTML(colaborador)}</span>
                        <span class="font-bold text-gray-900">${count}</span>
                    `;
                    medicalReportList.appendChild(item);
                }
            }
        }
        
        function renderPieChart(typeCounts) {
            if (myPieChart) {
                myPieChart.destroy();
            }
            
            if (!monthPieChartCanvas) {
                console.error("Canvas do gr√°fico n√£o foi encontrado!");
                return;
            }
            const ctx = monthPieChartCanvas.getContext('2d');
            
            const total = typeCounts.medical + typeCounts.time_bank + typeCounts.personal;
            
            const chartData = {
                labels: [
                    `Atestado (${typeCounts.medical})`, 
                    `Banco de Horas (${typeCounts.time_bank})`, 
                    `Pessoal (${typeCounts.personal})`
                ],
                datasets: [{
                    label: 'Aus√™ncias',
                    data: [
                        typeCounts.medical, 
                        typeCounts.time_bank, 
                        typeCounts.personal
                    ],
                    backgroundColor: [
                        '#FEE2E2', // red-100
                        '#DBEAFE', // blue-100
                        '#FFEDD5'  // orange-100
                    ],
                    borderColor: [
                        '#DC2626', // red-600
                        '#2563EB', // blue-600
                        '#EA580C'  // orange-600
                    ],
                    borderWidth: 1
                }]
            };
            
            if (total === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.save();
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.font = '14px Inter, sans-serif';
                ctx.fillStyle = '#64748b'; 
                ctx.fillText('Nenhum dado de aus√™ncia para este per√≠odo.', ctx.canvas.width / 2, ctx.canvas.height / 2);
                ctx.restore();
                return; 
            }

            myPieChart = new Chart(ctx, {
                type: 'pie',
                data: chartData, 
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    family: 'Inter, sans-serif'
                                }
                            }
                        }
                    }
                }
            });
        }


        function hideReportModal() {
            reportModal.firstElementChild.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                reportModal.classList.add('hidden');
                if (myPieChart) {
                    myPieChart.destroy();
                    myPieChart = null;
                }
            }, 150);
        }

        // --- Event Listeners ---
        
        prevMonthButton.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });
        
        nextMonthButton.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });
        
        calendarGrid.addEventListener('click', (e) => {
            const daySquare = e.target.closest('[data-date]');
            if (daySquare) {
                openModal(daySquare.dataset.date);
            }
        });
        
        closeModal.addEventListener('click', closeModalHandler);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModalHandler();
            }
        });
        
        diaTodoCheckbox.addEventListener('change', toggleTimeFields);

        saveAbsenceButton.addEventListener('click', handleSaveAbsence);
        saveEventButton.addEventListener('click', handleSaveEvent);
        saveBirthdayButton.addEventListener('click', handleSaveBirthday); // (NOVO)
        
        absencesList.addEventListener('click', handleDeleteAbsence);
        eventsList.addEventListener('click', handleDeleteEvent);
        
        tabAbsences.addEventListener('click', () => showTab('absences'));
        tabEvents.addEventListener('click', () => showTab('events'));
        tabBirthdays.addEventListener('click', () => showTab('birthdays')); // (NOVO)

        notificationClose.addEventListener('click', hideNotification);
        
        adminAccessButton.addEventListener('click', (e) => {
            e.preventDefault();
            showPasswordModal();
        });
        cancelPasswordButton.addEventListener('click', hidePasswordModal);
        submitPasswordButton.addEventListener('click', checkPassword);
        adminPasswordInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') checkPassword();
        });
        
        closeReportButton.addEventListener('click', hideReportModal);
        reportModal.addEventListener('click', (e) => {
            if (e.target === reportModal) hideReportModal();
        });
        
        reportPrevYearButton.addEventListener('click', () => {
            reportFilterDate.setFullYear(reportFilterDate.getFullYear() - 1);
            updateReportData();
        });
        reportNextYearButton.addEventListener('click', () => {
            reportFilterDate.setFullYear(reportFilterDate.getFullYear() + 1);
            updateReportData();
        });
        reportMonthSelect.addEventListener('change', () => {
            updateReportData();
        });

        // --- Inicializa√ß√£o ---
        initializeFirebase();
        renderCalendar();
        
        </script>
    </div>
</body>
</html>


